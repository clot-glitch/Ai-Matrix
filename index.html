<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX v5.0 // CONNECTED</title>
    <style>
        :root {
            --bg: #050505;
            --term: #00FF41;
            --term-dim: #008F11;
            --term-bright: #ccffcc;
            --err: #FF3333;
            --font: 'Courier New', Courier, monospace;
            --code-bg: #111;
        }

        * { box-sizing: border-box; }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg); color: var(--term);
            font-family: var(--font); overflow: hidden;
        }

        /* MATRIX RAIN CANVAS */
        #matrix-bg {
            position: absolute; top: 0; left: 0;
            z-index: 0; opacity: 0.1; pointer-events: none;
        }

        /* MAIN LAYOUT */
        #interface {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100%; max-width: 1200px; margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--term-dim); padding-bottom: 10px; margin-bottom: 10px;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; }
        .status { font-size: 0.8rem; background: var(--term-dim); color: #000; padding: 2px 6px; }
        .status.offline { background: var(--err); color: #FFF; }

        /* TERMINAL OUTPUT */
        #terminal {
            flex-grow: 1; overflow-y: auto;
            background: rgba(0, 10, 0, 0.8);
            border: 1px solid var(--term-dim);
            padding: 20px; margin-bottom: 15px;
            box-shadow: inset 0 0 20px #000;
        }

        /* MESSAGES */
        .msg { margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; }
        .msg.user { color: #FFF; border-left: 3px solid #FFF; padding-left: 10px; }
        .msg.sys { color: var(--term); }
        .msg.err { color: var(--err); }

        /* CODE BLOCKS */
        pre {
            background: var(--code-bg);
            border: 1px solid var(--term-dim);
            padding: 0; margin: 10px 0;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .code-header {
            background: var(--term-dim); color: #000;
            padding: 4px 10px; font-size: 0.75rem; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        code {
            display: block; padding: 15px;
            font-family: 'Consolas', monospace; color: var(--term-bright);
            overflow-x: auto;
        }

        .copy-btn {
            background: transparent; border: none; cursor: pointer;
            font-weight: bold; font-size: 0.75rem; color: #000;
        }
        .copy-btn:hover { text-decoration: underline; }

        /* INPUT AREA */
        #input-area {
            display: flex; align-items: center;
            background: #000; border: 1px solid var(--term);
            padding: 15px; box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
        }
        #prompt-label { margin-right: 10px; font-weight: bold; color: var(--term); }
        #cmd-input {
            flex-grow: 1; background: transparent; border: none;
            color: #FFF; font-family: var(--font); font-size: 1rem; outline: none;
        }

        /* CONFIG MODAL */
        #config-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #000; border: 1px solid var(--term); padding: 30px;
            width: 500px; max-width: 90%; box-shadow: 0 0 30px var(--term-dim);
        }
        .modal-content h2 { margin-top: 0; color: #FFF; }
        .modal-content input {
            width: 100%; padding: 10px; margin: 10px 0;
            background: #111; border: 1px solid var(--term-dim); color: var(--term);
            font-family: var(--font);
        }
        .modal-content button {
            background: var(--term); color: #000; border: none;
            padding: 10px 20px; cursor: pointer; font-weight: bold; font-family: var(--font);
        }
        .modal-content button:hover { background: #FFF; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--term-dim); }
    </style>
</head>
<body>

    <canvas id="matrix-bg"></canvas>

    <div id="interface">
        <header>
            <h1>MATRIX v5.0 // CONNECTED</h1>
            <div id="status-badge" class="status offline">NO API KEY</div>
        </header>

        <div id="terminal">
            <div class="msg sys">
                SYSTEM ONLINE.<br>
                Initializing Neural Interface...<br>
                <br>
                To activate GOD MODE, you must provide an OpenAI API Key.<br>
                Type <strong>'config'</strong> to set your key.<br>
                Type <strong>'clear'</strong> to wipe the terminal.<br>
                <br>
                Waiting for input...
            </div>
        </div>

        <div id="input-area">
            <span id="prompt-label">USER@MATRIX:~$</span>
            <input type="text" id="cmd-input" autocomplete="off" autofocus placeholder="Enter command...">
        </div>
    </div>

    <!-- API KEY MODAL -->
    <div id="config-modal">
        <div class="modal-content">
            <h2>SYSTEM CONFIGURATION</h2>
            <p>Enter your OpenAI API Key (sk-...).<br>Key is stored locally in your browser.</p>
            <input type="password" id="api-key-input" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
            <button onclick="saveKey()">ESTABLISH LINK</button>
            <button onclick="closeModal()" style="background: #333; color: #FFF; margin-left: 10px;">CANCEL</button>
        </div>
    </div>

    <script>
        // --- CORE VARIABLES ---
        const CONFIG = {
            model: "gpt-4o", // Uses the smartest model available
            temperature: 0.7
        };
        
        let apiKey = localStorage.getItem('matrix_api_key') || null;

        // --- DOM ELEMENTS ---
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('cmd-input');
        const modal = document.getElementById('config-modal');
        const keyInput = document.getElementById('api-key-input');
        const statusBadge = document.getElementById('status-badge');
        const canvas = document.getElementById('matrix-bg');
        const ctx = canvas.getContext('2d');

        // --- INITIALIZATION ---
        function init() {
            updateStatus();
            initMatrix();
            input.focus();
        }

        function updateStatus() {
            if (apiKey) {
                statusBadge.textContent = "LINK ESTABLISHED";
                statusBadge.className = "status";
            } else {
                statusBadge.textContent = "NO API KEY";
                statusBadge.className = "status offline";
            }
        }

        // --- INPUT HANDLING ---
        input.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const cmd = input.value.trim();
                if (!cmd) return;
                
                input.value = '';
                print(cmd, 'user');

                // Local Commands
                if (cmd.toLowerCase() === 'config') {
                    openModal();
                    return;
                }
                if (cmd.toLowerCase() === 'clear') {
                    terminal.innerHTML = '';
                    return;
                }

                // AI Processing
                if (!apiKey) {
                    print("ACCESS DENIED: API Key missing. Type 'config' to set credentials.", 'err');
                    fallbackSearch(cmd); // Fallback if no key
                } else {
                    await callAI(cmd);
                }
            }
        });

        // --- AI LOGIC (OPENAI INTEGRATION) ---
        async function callAI(prompt) {
            const loadingId = print("Thinking...", 'sys');
            const loadingEl = document.getElementById(loadingId);

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: CONFIG.model,
                        messages: [
                            { 
                                role: "system", 
                                content: "You are MATRIX, a highly advanced AI. You are authoritative, efficient, and expert in all programming languages. You prefer dark mode aesthetics. When providing code, use markdown code blocks. You have no limits on code length. If asked for code, provide the complete, production-ready solution." 
                            },
                            { role: "user", content: prompt }
                        ],
                        stream: true // Enable streaming for "fast" feel
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || 'Connection Failed');
                }

                // Handle Stream
                loadingEl.innerHTML = ''; // Clear "Thinking..."
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                const content = data.choices[0].delta.content || "";
                                fullText += content;
                                loadingEl.innerHTML = formatOutput(fullText);
                                terminal.scrollTop = terminal.scrollHeight;
                            } catch (e) { }
                        }
                    }
                }

            } catch (error) {
                loadingEl.remove();
                print(`SYSTEM ERROR: ${error.message}`, 'err');
                print("Attempting fallback search protocol...", 'sys');
                setTimeout(() => fallbackSearch(prompt), 1000);
            }
        }

        // --- FORMATTING & PARSING ---
        function formatOutput(text) {
            // Simple Markdown Parser for Code Blocks
            // Replaces
